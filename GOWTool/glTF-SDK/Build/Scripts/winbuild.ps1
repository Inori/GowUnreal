# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

<#
.SYNOPSIS
Build the Windows solutions from the command line.

.DESCRIPTION
Builds the Visual Studio projects generated by wininit.ps1

.PARAMETER NoNuGet
Disable build of NuGet packages

.EXAMPLE
winbuild.ps1
#>

[CmdletBinding()]
param(
    [switch]$NoNuGet,
    [switch]$NoArm,
    [switch]$NoArm64,
    [switch]$Nox64,
    [switch]$NoWin32,
    [switch]$NoDebug,
    [switch]$NoRelease
)

$ErrorActionPreference = "stop"

function BuildPlatform($folder)
{
    Write-Host "Build $folder"
    Push-Location "$PSScriptRoot/../../Built/Int/$folder"
    try
    {
        if (!$NoDebug)
        {
            cmake --build . --target install --config Debug
        }

        if (!$NoRelease)
        {
            cmake --build . --target install --config Release
        }
    }
    finally
    {
        Pop-Location
    }
}


function BuildNuGet()
{
    #nuget pack $PSScriptRoot/GLTFSDK/GLTFSDK.macOS.CPP.nuspec -OutputDirectory $PSScriptRoot/Built/Out/NuGet
    try
    {
        # You must install CoApp for this to work.
        # See http://coapp.org/tutorials/installation.html
        # Also, if it still doesn't work, try this https://github.com/appveyor/ci/issues/1446
        Write-NuGetPackage $PSScriptRoot/../../GLTFSDK/GLTFSDK.Windows.CPP.autopkg
    }
    catch
    {
        Write-Error "Unable to generate NuGet package.  Check that you have CoApp installed."
    }
}

function Main()
{
    if (!$NoWin32)
    {
        BuildPlatform "cmake_Win32"
    }

    if (!$Nox64)
    {
        BuildPlatform "cmake_x64"
    }

    if (!$NoArm)
    {
        BuildPlatform "cmake_ARM"
    }

    if (!$NoArm64)
    {
        BuildPlatform "cmake_ARM64"
    }

    if (!$NoNuGet)
    {
        BuildNuGet
    }
}

Main
